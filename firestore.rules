rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Função para verificar se o usuário está autenticado
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Permitir acesso para usuários autenticados (desenvolvimento)
    match /{document=**} {
      allow read, write: if isSignedIn();
    }
  }
}
                       // Não permitir remover o criador
                       resource.data.createdBy in request.resource.data.participants;
      
      // Permitir deletar apenas para o criador
      allow delete: if isOwner(resource.data.createdBy);
    }
    
    // REGRAS PARA EVENTOS
    match /events/{eventId} {
      // Permitir leitura para participantes da viagem
      allow read: if isParticipant(resource.data.tripId);
      
      // Permitir criar para participantes da viagem
      allow create: if isSignedIn() && 
                       isParticipant(request.resource.data.tripId) &&
                       request.auth.uid == request.resource.data.createdBy;
      
      // Permitir atualizar apenas para o criador ou participantes
      allow update: if isParticipant(resource.data.tripId);
      
      // Permitir deletar apenas para o criador do evento
      allow delete: if isOwner(resource.data.createdBy);
    }
    
    // REGRAS PARA DESPESAS
    match /expenses/{expenseId} {
      // Permitir leitura para participantes da viagem
      allow read: if isParticipant(resource.data.tripId);
      
      // Permitir criar para participantes da viagem
      allow create: if isSignedIn() && 
                       isParticipant(request.resource.data.tripId) &&
                       // Validar que paidBy é um participante
                       request.resource.data.paidBy in get(/databases/$(database)/documents/trips/$(request.resource.data.tripId)).data.participants &&
                       // Validar que amount é positivo
                       request.resource.data.amount > 0;
      
      // Permitir atualizar para participantes da viagem
      allow update: if isParticipant(resource.data.tripId) &&
                       request.resource.data.amount > 0;
      
      // Permitir deletar para participantes da viagem
      allow delete: if isParticipant(resource.data.tripId);
    }
    
    // Bloquear acesso a qualquer outra coleção
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
